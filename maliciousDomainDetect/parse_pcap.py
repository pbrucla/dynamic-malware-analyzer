#!/usr/bin/python3

try:
    from key import API_KEY
except:
    API_KEY = input("Enter an API key: ")

import pyshark
import vt

OWN_IP_ADDR = '10.0.2.15'
def extract_ip_addresses(pcap_file):
    source_addrs = set()
    dest_addrs = set()
    cap = pyshark.FileCapture(pcap_file)

    for packet in cap:
        if 'IP' in packet:
            ip_src = packet.ip.src
            ip_dest = packet.ip.dst
            if ip_src != OWN_IP_ADDR:
                source_addrs.add(ip_src)
            if ip_dest != OWN_IP_ADDR:
                dest_addrs.add(ip_dest)

    return source_addrs, dest_addrs

def query_ip(ip_address,client):
    analysis = client.scan_url(ip_address)
    analysis = client.get_object("/analyses/{}", analysis.id)
    stats = analysis.stats
    total_sus = stats['malicious'] + stats['suspicious']
    if total_sus > 0:
        return True
    return False

if __name__ == '__main__':
    pcap_file = 'out.pcap'
    source_addrs, dest_addrs = extract_ip_addresses(pcap_file)
    client = vt.Client(API_KEY)

    dest_addrs.add('1.tcp.sa.ngrok.io:26109')

    for addr in dest_addrs:
        if query_ip(addr,client):
            print(f'{addr} is suspicious')
        else:
            print(f'{addr} is not suspicious')
    client.close()




            
